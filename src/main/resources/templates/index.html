<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Wedding Planner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <style>
        :root{
            /* Color system */
            --bg1:#fdf2f8;
            --bg2:#eef2ff;
            --bg3:#f0fdf4;

            --panel:#ffffff;
            --panel2:#fbfbff;

            --primary:#6366f1;
            --secondary:#ec4899;
            --primary2:#4338ca;

            --accent:#d4af37;
            --text:#0f172a;
            --muted:#64748b;
            --border:#e5e7eb;
            --danger:#ef4444;
            --success:#22c55e;

            --overlay:rgba(15,23,42,.6);
            --radius:20px;
            --shadow:0 20px 50px rgba(2,6,23,.12);
            --shadow2:0 14px 30px rgba(2,6,23,.10);
        }

        *{box-sizing:border-box}

        body{
            margin:0;
            padding:16px;
            font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
            color:var(--text);
        }

        .topbar{
            display:flex;
            align-items:flex-start;
            justify-content:space-between;
            gap:12px;
            margin-bottom:16px;
        }

        h1{
            margin:0;
            font-size:1.8rem;
            font-weight:900;
            line-height:1.1;
            background: linear-gradient(90deg,var(--primary),var(--secondary));
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
        }

        .lang{
            display:flex;
            gap:8px;
            align-items:center;
            background:rgba(255,255,255,.65);
            border:1px solid rgba(229,231,235,.9);
            border-radius:999px;
            padding:6px;
            box-shadow:0 10px 25px rgba(2,6,23,.08);
            backdrop-filter: blur(8px);
        }

        .lang button{
            border:none;
            background:transparent;
            cursor:pointer;
            padding:8px 10px;
            border-radius:999px;
            font-weight:800;
            transition:.15s;
            color:var(--text);
        }
        .lang button:hover{background:rgba(99,102,241,.10)}
        .lang button.active{
            background:linear-gradient(135deg,var(--primary),var(--secondary));
            color:#fff;
            box-shadow:0 12px 24px rgba(99,102,241,.18);
        }

        .grid{
            display:grid;
            grid-template-columns:1fr;
            gap:18px;
        }

        .panel{
            background:linear-gradient(180deg,var(--panel),var(--panel2));
            border:1px solid rgba(229,231,235,.9);
            border-radius:var(--radius);
            padding:18px;
            box-shadow:var(--shadow);
        }

        h3{
            margin:0 0 14px;
            font-size:1.15rem;
            font-weight:900;
            display:flex;
            align-items:center;
            gap:10px;
        }
        .pill{
            font-size:.72rem;
            font-weight:900;
            padding:4px 10px;
            border-radius:999px;
            background:rgba(236,72,153,.10);
            color:#9d174d;
            border:1px solid rgba(236,72,153,.18);
        }

        /* Inputs */
        .stack{display:grid;gap:10px;margin-bottom:14px}

        input,textarea{
            width:100%;
            padding:12px 14px;
            border-radius:16px;
            border:1px solid var(--border);
            font-size:15px;
            background:rgba(248,250,252,.9);
            outline:none;
            transition:.15s;
        }
        input:focus,textarea:focus{
            border-color:rgba(99,102,241,.6);
            box-shadow:0 0 0 4px rgba(99,102,241,.15);
            background:#fff;
        }
        textarea{min-height:90px;resize:vertical}

        /* Buttons */
        button{
            border:none;
            border-radius:16px;
            padding:12px 14px;
            font-weight:900;
            cursor:pointer;
            transition:.15s;
        }
        .btn-primary{
            background:linear-gradient(135deg,var(--primary),var(--secondary));
            color:#fff;
            box-shadow:0 12px 24px rgba(99,102,241,.18);
        }
        .btn-primary:hover{transform:translateY(-1px); box-shadow:0 16px 30px rgba(99,102,241,.22)}
        .btn-ghost{
            background:transparent;
            border:1px solid rgba(229,231,235,.9);
            color:var(--text);
        }
        .btn-ghost:hover{background:rgba(148,163,184,.12)}
        .btn-icon{
            background:transparent;
            padding:6px 10px;
            border-radius:14px;
            font-size:16px;
        }
        .btn-icon:hover{background:rgba(148,163,184,.15)}
        .btn-danger{color:var(--danger)}
        .price{
            font-weight:1000;
            color:var(--accent);
            white-space:nowrap;
        }
        .muted{color:var(--muted);font-size:13px}

        /* Prestations list */
        .cards{display:grid;gap:12px}
        .card{
            background:linear-gradient(135deg,#ffffff,#f8fafc);
            border:1px solid rgba(229,231,235,.95);
            border-radius:18px;
            padding:14px;
            display:flex;
            justify-content:space-between;
            gap:12px;
            cursor:grab;
            user-select:none;
            transition:.15s;
            box-shadow:0 10px 25px rgba(2,6,23,.06);
        }
        .card:hover{transform:translateY(-2px); box-shadow:0 16px 35px rgba(2,6,23,.10)}
        .card-left{flex:1; min-width:0}
        .card-title{font-weight:950;margin:0 0 6px;font-size:15px}
        .card-desc{
            font-size:13px;
            color:var(--muted);
            display:-webkit-box;
            -webkit-line-clamp:2;
            -webkit-box-orient:vertical;
            overflow:hidden;
            cursor:pointer;
        }
        .card-desc:hover{text-decoration:underline}
        .card-right{display:flex; gap:8px; align-items:center; flex-shrink:0}

        /* Scenarios */
        .scenarios{display:grid;gap:14px}
        .scenario{
            background:linear-gradient(135deg,#f8fafc,#eef2ff);
            border:2px dashed rgba(99,102,241,.30);
            border-radius:18px;
            padding:14px;
            min-height:150px;
            transition:.15s;
        }
        .scenario.dragover{
            background:linear-gradient(135deg,#eef2ff,#ecfeff);
            border-color:rgba(99,102,241,.85);
            box-shadow:0 18px 50px rgba(99,102,241,.12);
        }

        .scenario-header{
            display:flex;
            justify-content:space-between;
            align-items:flex-start;
            gap:10px;
            margin-bottom:10px;
        }
        .scenario-name{
            font-weight:950;
            font-size:15px;
            line-height:1.2;
            word-break:break-word;
            overflow-wrap:anywhere;
        }
        .scenario-actions{
            display:flex;
            gap:6px;
            align-items:center;
            flex-shrink:0;
        }

        .items{display:grid;gap:8px}
        .item{
            background:#fff;
            border:1px solid rgba(229,231,235,.95);
            border-radius:16px;
            padding:10px 12px;
            display:flex;
            align-items:flex-start; /* allows multiline title */
            gap:10px;
            box-shadow:0 8px 18px rgba(2,6,23,.05);
        }
        /* IMPORTANT: full title visible in scenarios */
        .item-title{
            font-weight:800;
            min-width:0;
            white-space:normal;
            word-break:break-word;
            overflow-wrap:anywhere;
            line-height:1.35;
            flex:1;
        }
        .item-right{
            display:flex;
            gap:8px;
            align-items:center;
            flex-shrink:0;
        }

        /* Modals */
        .modal{
            position:fixed; inset:0;
            background:var(--overlay);
            display:none;
            align-items:center;
            justify-content:center;
            z-index:1000;
            padding:16px;
        }
        .modal.show{display:flex}
        .modal-content{
            background:linear-gradient(180deg,#ffffff,#f8fafc);
            border-radius:24px;
            padding:18px;
            width:100%;
            max-width:620px;
            box-shadow:0 60px 140px rgba(2,6,23,.40);
            border:1px solid rgba(229,231,235,.9);
        }
        .modal-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:10px;
            margin-bottom:10px;
        }
        .modal-title{
            font-weight:1000;
            font-size:1.15rem;
            background:linear-gradient(90deg,var(--primary),var(--secondary));
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
        }
        .modal-footer{
            display:flex;
            justify-content:flex-end;
            gap:10px;
            margin-top:12px;
        }

        /* RTL support */
        html[dir="rtl"]{text-align:right}
        html[dir="rtl"] .scenario-header,
        html[dir="rtl"] .item,
        html[dir="rtl"] .card{direction:rtl}
        html[dir="rtl"] .scenario-actions,
        html[dir="rtl"] .card-right,
        html[dir="rtl"] .item-right{flex-direction:row-reverse}

        @media(min-width:900px){
            body{padding:24px}
            .grid{grid-template-columns:420px 1fr}
            .scenarios{grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
        }

        /* Toast notifications */
        .toast-container{
            position:fixed;
            top:20px;
            right:20px;
            z-index:2000;
            display:flex;
            flex-direction:column;
            gap:10px;
            pointer-events:none;
        }
        .toast{
            background:#fff;
            border-radius:12px;
            padding:14px 18px;
            box-shadow:0 8px 30px rgba(2,6,23,.15);
            min-width:250px;
            max-width:400px;
            display:flex;
            align-items:center;
            gap:10px;
            pointer-events:auto;
            animation:slideIn .3s ease;
            border-left:4px solid var(--primary);
        }
        .toast.success{border-left-color:var(--success)}
        .toast.error{border-left-color:var(--danger)}
        .toast-message{flex:1;font-size:.9rem;color:var(--text)}
        @keyframes slideIn{
            from{transform:translateX(400px);opacity:0}
            to{transform:translateX(0);opacity:1}
        }
        @keyframes slideOut{
            from{transform:translateX(0);opacity:1}
            to{transform:translateX(400px);opacity:0}
        }
        .toast.hiding{animation:slideOut .3s ease}
    </style>
</head>

<body>

<div class="topbar">
    <div>
        <h1 data-i18n="app.title">üíç Wedding Planner</h1>
        <div class="muted" data-i18n="app.subtitle">Organise tes prestations et compare tes sc√©narios.</div>
    </div>

    <div class="lang" aria-label="Language switch">
        <button type="button" id="langFr" onclick="setLang('fr')">üá´üá∑ FR</button>
        <button type="button" id="langAr" onclick="setLang('ar')">üá≤üá¶ AR</button>
        <button type="button" id="langEs" onclick="setLang('es')">üá™üá∏ ES</button>
    </div>
</div>

<div class="grid">

    <!-- PRESTATIONS -->
    <div class="panel">
        <h3>
            <span data-i18n="prestations.title">Prestations</span>
            <span class="pill" data-i18n="prestations.dragHintPill">Drag & Drop</span>
        </h3>

        <div class="stack">
            <input id="pTitre" data-i18n-placeholder="prestations.namePh" placeholder="Nom de la prestation"/>
            <textarea id="pDesc" data-i18n-placeholder="prestations.descPh" placeholder="Description d√©taill√©e"></textarea>
            <input id="pPrix" data-i18n-placeholder="prestations.pricePh" placeholder="Prix (‚Ç¨)"/>
            <button type="button" class="btn-primary" onclick="createPrestation()" data-i18n="prestations.addBtn">Ajouter la prestation</button>
            <div class="muted" data-i18n="prestations.dragHint">Astuce : glisse une prestation dans un sc√©nario.</div>
        </div>

        <div class="cards" id="prestations"></div>
    </div>

    <!-- SCENARIOS -->
    <div class="panel">
        <h3>
            <span data-i18n="scenarios.title">Sc√©narios</span>
            <span class="pill" data-i18n="scenarios.totalPill">Totaux</span>
        </h3>

        <div class="stack">
            <input id="scenarioName" data-i18n-placeholder="scenarios.namePh" placeholder="Nom du sc√©nario"/>
            <button type="button" class="btn-primary" onclick="createScenario()" data-i18n="scenarios.createBtn">Cr√©er le sc√©nario</button>
        </div>

        <div class="scenarios" id="scenarios">
            <div class="scenario"
                 th:each="s : ${scenarios}"
                 th:attr="data-scenario-id=${s.id}">
                <div class="scenario-header">
                    <div class="scenario-name"
                         th:text="${s.nom}"
                         th:attr="data-scenario-name=${s.id}">
                    </div>
                    <div class="scenario-actions">
                        <span class="price" th:attr="data-total-for=${s.id}">0 ‚Ç¨</span>

                        <!-- on garde exactement tes endpoints existants -->
                        <button type="button" class="btn-icon"
                                th:attr="onclick=|openScenarioEdit(${s.id})|"
                                data-i18n-title="scenarios.renameTitle">
                            ‚úé
                        </button>
                        <button type="button" class="btn-icon btn-danger" th:attr="onclick=|deleteScenario(${s.id})|" title="Supprimer" data-i18n-title="scenarios.deleteTitle">üóë</button>
                    </div>
                </div>
                <div class="items" th:attr="data-items-for=${s.id}"></div>
            </div>
        </div>
    </div>

</div>

<!-- MODAL: Lecture description -->
<div class="modal" id="descModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="descTitle">
        <div class="modal-header">
            <div class="modal-title" id="descTitle"></div>
            <button type="button" class="btn-icon" onclick="closeModal('descModal')" aria-label="Close">‚úï</button>
        </div>
        <div id="descBody" style="white-space:pre-line;color:#334155"></div>
        <div class="modal-footer">
            <button type="button" class="btn-ghost" onclick="closeModal('descModal')" data-i18n="modal.close">Fermer</button>
        </div>
    </div>
</div>

<!-- MODAL: Edit prestation -->
<div class="modal" id="editModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
        <div class="modal-header">
            <div class="modal-title" id="editModalTitle" data-i18n="edit.title">√âditer la prestation</div>
            <button type="button" class="btn-icon" onclick="closeModal('editModal')" aria-label="Close">‚úï</button>
        </div>

        <input type="hidden" id="editId"/>

        <div class="stack">
            <input id="editTitre" data-i18n-placeholder="edit.namePh" placeholder="Nom"/>
            <textarea id="editDesc" data-i18n-placeholder="edit.descPh" placeholder="Description"></textarea>
            <input id="editPrix" data-i18n-placeholder="edit.pricePh" placeholder="Prix (‚Ç¨)"/>
            <div class="muted" data-i18n="edit.hint">Les changements sont enregistr√©s via l‚ÄôAPI.</div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn-ghost" onclick="closeModal('editModal')" data-i18n="modal.cancel">Annuler</button>
            <button type="button" class="btn-primary" onclick="saveEdit()" data-i18n="modal.save">Enregistrer</button>
        </div>
    </div>
</div>
<!-- MODAL: Edit sc√©nario -->
<div class="modal" id="editScenarioModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="editScenarioTitle">
        <div class="modal-header">
            <div class="modal-title" id="editScenarioTitle" data-i18n="scenarioEdit.title">
                √âditer le sc√©nario
            </div>
            <button type="button" class="btn-icon"
                    onclick="closeModal('editScenarioModal')" aria-label="Close">‚úï</button>
        </div>

        <input type="hidden" id="editScenarioId"/>

        <div class="stack">
            <input id="editScenarioName"
                   data-i18n-placeholder="scenarioEdit.namePh"
                   placeholder="Nom du sc√©nario"/>
            <div class="muted" data-i18n="scenarioEdit.hint">
                Le nom sera mis √† jour imm√©diatement.
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn-ghost"
                    onclick="closeModal('editScenarioModal')"
                    data-i18n="modal.cancel">
                Annuler
            </button>
            <button type="button" class="btn-primary"
                    onclick="saveScenarioEdit()"
                    data-i18n="modal.save">
                Enregistrer
            </button>
        </div>
    </div>
</div>

<script>
    /* ================= I18N ================= */
    const I18N = {
        fr: {
            dir: "ltr",
            app: {
                title: "üíç Wedding Planner",
                subtitle: "Organise tes prestations et compare tes sc√©narios."
            },
            prestations: {
                title: "Prestations",
                dragHintPill: "Drag & Drop",
                namePh: "Nom de la prestation",
                descPh: "Description d√©taill√©e",
                pricePh: "Prix (‚Ç¨)",
                addBtn: "Ajouter la prestation",
                dragHint: "Astuce : glisse une prestation dans un sc√©nario.",
                readDesc: "Lire la description",
                noDesc: "Aucune description."
            },
            scenarios: {
                title: "Sc√©narios",
                totalPill: "Totaux",
                namePh: "Nom du sc√©nario",
                createBtn: "Cr√©er le sc√©nario",
                renameTitle: "Renommer",
                deleteTitle: "Supprimer",
                removeItemTitle: "Retirer du sc√©nario"
            },
            scenarioEdit: {
                title: "√âditer le sc√©nario",
                namePh: "Nom du sc√©nario",
                hint: "Le nom sera mis √† jour imm√©diatement."
            },
            modal: {
                close: "Fermer",
                cancel: "Annuler",
                save: "Enregistrer"
            },
            edit: {
                title: "√âditer la prestation",
                namePh: "Nom",
                descPh: "Description",
                pricePh: "Prix (‚Ç¨)",
                hint: "Les changements sont enregistr√©s via l‚ÄôAPI."
            }
,
            confirm: {
                deletePrestation: "√ätes-vous s√ªr de vouloir supprimer cette prestation ? Elle sera retir√©e de tous les sc√©narios.",
                deleteScenario: "√ätes-vous s√ªr de vouloir supprimer ce sc√©nario ?"
            },
            notifications: {
                error: "Une erreur est survenue",
                prestationCreated: "Prestation cr√©√©e",
                prestationUpdated: "Prestation mise √† jour",
                prestationDeleted: "Prestation supprim√©e",
                scenarioCreated: "Sc√©nario cr√©√©",
                scenarioUpdated: "Sc√©nario mis √† jour",
                scenarioDeleted: "Sc√©nario supprim√©"
            }
        },
        ar: {
            dir: "rtl",
            app: {
                title: "üíç ŸÖÿÆÿ∑ÿ∑ ÿßŸÑÿ≤ŸÅÿßŸÅ",
                subtitle: "ŸÜÿ∏ŸëŸÖ ÿßŸÑÿÆÿØŸÖÿßÿ™ ŸàŸÇÿßÿ±ŸÜ ÿßŸÑÿ≥ŸäŸÜÿßÿ±ŸäŸàŸáÿßÿ™."
            },
            prestations: {
                title: "ÿßŸÑÿÆÿØŸÖÿßÿ™",
                dragHintPill: "ÿ≥ÿ≠ÿ® Ÿàÿ•ŸÅŸÑÿßÿ™",
                namePh: "ÿßÿ≥ŸÖ ÿßŸÑÿÆÿØŸÖÿ©",
                descPh: "ÿßŸÑŸàÿµŸÅ ÿßŸÑÿ™ŸÅÿµŸäŸÑŸä",
                pricePh: "ÿßŸÑÿ≥ÿπÿ± (‚Ç¨)",
                addBtn: "ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿÆÿØŸÖÿ©",
                dragHint: "ŸÜÿµŸäÿ≠ÿ©: ÿßÿ≥ÿ≠ÿ® ÿÆÿØŸÖÿ© ÿ•ŸÑŸâ ÿ≥ŸäŸÜÿßÿ±ŸäŸà.",
                readDesc: "ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸàÿµŸÅ",
                noDesc: "ŸÑÿß ŸäŸàÿ¨ÿØ ŸàÿµŸÅ."
            },
            scenarios: {
                title: "ÿßŸÑÿ≥ŸäŸÜÿßÿ±ŸäŸàŸáÿßÿ™",
                totalPill: "ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä",
                namePh: "ÿßÿ≥ŸÖ ÿßŸÑÿ≥ŸäŸÜÿßÿ±ŸäŸà",
                createBtn: "ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≥ŸäŸÜÿßÿ±ŸäŸà",
                renameTitle: "ÿ•ÿπÿßÿØÿ© ÿ™ÿ≥ŸÖŸäÿ©",
                deleteTitle: "ÿ≠ÿ∞ŸÅ",
                removeItemTitle: "ÿ•ÿ≤ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑÿ≥ŸäŸÜÿßÿ±ŸäŸà"
            },
            scenarioEdit: {
                title: "ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ≥ŸäŸÜÿßÿ±ŸäŸà",
                namePh: "ÿßÿ≥ŸÖ ÿßŸÑÿ≥ŸäŸÜÿßÿ±ŸäŸà",
                hint: "ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿßÿ≥ŸÖ ŸÅŸàÿ±Ÿãÿß."
            },
            modal: {
                close: "ÿ•ÿ∫ŸÑÿßŸÇ",
                cancel: "ÿ•ŸÑÿ∫ÿßÿ°",
                save: "ÿ≠ŸÅÿ∏"
            },
            edit: {
                title: "ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿÆÿØŸÖÿ©",
                namePh: "ÿßŸÑÿßÿ≥ŸÖ",
                descPh: "ÿßŸÑŸàÿµŸÅ",
                pricePh: "ÿßŸÑÿ≥ÿπÿ± (‚Ç¨)",
                hint: "Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿπÿ®ÿ± ÿßŸÑŸÄ API."
            }
,
            confirm: {
                deletePrestation: "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿÆÿØŸÖÿ©ÿü ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ™Ÿáÿß ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≥ŸäŸÜÿßÿ±ŸäŸàŸáÿßÿ™.",
                deleteScenario: "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ≥ŸäŸÜÿßÿ±ŸäŸàÿü"
            },
            notifications: {
                error: "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£",
                prestationCreated: "ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿÆÿØŸÖÿ©",
                prestationUpdated: "ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿÆÿØŸÖÿ©",
                prestationDeleted: "ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿÆÿØŸÖÿ©",
                scenarioCreated: "ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≥ŸäŸÜÿßÿ±ŸäŸà",
                scenarioUpdated: "ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≥ŸäŸÜÿßÿ±ŸäŸà",
                scenarioDeleted: "ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≥ŸäŸÜÿßÿ±ŸäŸà"
            }
        },
        es: {
            dir: "ltr",
            app: {
                title: "üíç Wedding Planner",
                subtitle: "Organiza los servicios y compara escenarios."
            },
            prestations: {
                title: "Servicios",
                dragHintPill: "Arrastrar y soltar",
                namePh: "Nombre del servicio",
                descPh: "Descripci√≥n detallada",
                pricePh: "Precio (‚Ç¨)",
                addBtn: "A√±adir servicio",
                dragHint: "Consejo: arrastra un servicio a un escenario.",
                readDesc: "Leer descripci√≥n",
                noDesc: "Sin descripci√≥n."
            },
            scenarios: {
                title: "Escenarios",
                totalPill: "Totales",
                namePh: "Nombre del escenario",
                createBtn: "Crear escenario",
                renameTitle: "Renombrar",
                deleteTitle: "Eliminar",
                removeItemTitle: "Quitar del escenario"
            },
            scenarioEdit: {
                title: "Editar escenario",
                namePh: "Nombre del escenario",
                hint: "El nombre se actualizar√° inmediatamente."
            },
            modal: {
                close: "Cerrar",
                cancel: "Cancelar",
                save: "Guardar"
            },
            edit: {
                title: "Editar servicio",
                namePh: "Nombre",
                descPh: "Descripci√≥n",
                pricePh: "Precio (‚Ç¨)",
                hint: "Los cambios se guardan v√≠a API."
            }
,
            confirm: {
                deletePrestation: "¬øEst√°s seguro de que quieres eliminar este servicio? Se eliminar√° de todos los escenarios.",
                deleteScenario: "¬øEst√°s seguro de que quieres eliminar este escenario?"
            },
            notifications: {
                error: "Ha ocurrido un error",
                prestationCreated: "Servicio creado",
                prestationUpdated: "Servicio actualizado",
                prestationDeleted: "Servicio eliminado",
                scenarioCreated: "Escenario creado",
                scenarioUpdated: "Escenario actualizado",
                scenarioDeleted: "Escenario eliminado"
            }
        }
    };

    function t(key){
        const lang = window.__lang || "fr";
        const dict = I18N[lang] || I18N.fr;
        const parts = String(key).split(".");
        let cur = dict;
        for(const p of parts) cur = cur?.[p];
        return (cur ?? key);
    }

    /* ================= TOAST NOTIFICATIONS ================= */
    function showToast(message, type = 'success'){
        let container = document.getElementById('toast-container');
        if(!container){
            container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container';
            document.body.appendChild(container);
        }

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const messageEl = document.createElement('div');
        messageEl.className = 'toast-message';
        messageEl.textContent = message;
        toast.appendChild(messageEl);

        container.appendChild(toast);

        setTimeout(()=>{
            toast.classList.add('hiding');
            setTimeout(()=> toast.remove(), 300);
        }, 3000);
    }

    function applyI18n(){
        // texts
        document.querySelectorAll("[data-i18n]").forEach(el=>{
            el.textContent = t(el.dataset.i18n);
        });

        // placeholders
        document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
            el.placeholder = t(el.dataset.i18nPlaceholder);
        });

        // titles
        document.querySelectorAll("[data-i18n-title]").forEach(el=>{
            el.title = t(el.dataset.i18nTitle);
        });

        // dir/lang + active buttons
        const lang = window.__lang || "fr";
        const dict = I18N[lang] || I18N.fr;
        document.documentElement.dir = dict.dir;
        document.documentElement.lang = lang;

        document.getElementById("langFr").classList.toggle("active", lang==="fr");
        document.getElementById("langAr").classList.toggle("active", lang==="ar");
        document.getElementById("langEs").classList.toggle("active", lang==="es");
    }

    function setLang(lang){
        window.__lang = (I18N[lang] ? lang : "fr");
        localStorage.setItem("lang", window.__lang);
        applyI18n();
        // re-render lists texts that depend on translations
        loadPrestations();
        refreshAllScenarios();
    }

    /* ================= UTILS ================= */
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const parsePrice = v => Number(String(v ?? '').replace(',','.')) || 0;

    /* ================= MODALS ================= */
    function openModal(id){
        const m = document.getElementById(id);
        m.classList.add('show');
        m.setAttribute('aria-hidden','false');
    }
    function closeModal(id){
        const m = document.getElementById(id);
        m.classList.remove('show');
        m.setAttribute('aria-hidden','true');
    }
    // close on overlay click
    $$('.modal').forEach(m=>{
        m.addEventListener('click', (e)=>{
            if(e.target === m) closeModal(m.id);
        });
    });
    // close on ESC
    document.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape'){
            $$('.modal.show').forEach(m=>closeModal(m.id));
        }
    });

    function showDesc(title, desc){
        $('#descTitle').textContent = title || t("prestations.readDesc");
        $('#descBody').textContent = (desc && desc.trim()) ? desc : t("prestations.noDesc");
        openModal('descModal');
    }

    /* ================= PRESTATIONS ================= */
    async function loadPrestations(){
        const r = await fetch('/api/admin/prestations');
        const d = await r.json();

        const list = $('#prestations');
        list.innerHTML = '';

        d.forEach(p=>{
            const card = document.createElement('div');
            card.className = 'card';
            card.draggable = true;
            card.dataset.prestationId = p.id;

            const left = document.createElement('div');
            left.className = 'card-left';

            const title = document.createElement('div');
            title.className = 'card-title';
            title.textContent = p.titre ?? '';

            const desc = document.createElement('div');
            desc.className = 'card-desc';
            desc.textContent = (p.description && p.description.trim())
                ? p.description
                : t("prestations.readDesc");
            desc.addEventListener('click', ()=> showDesc(p.titre, p.description));

            left.appendChild(title);
            left.appendChild(desc);

            const right = document.createElement('div');
            right.className = 'card-right';

            const price = document.createElement('div');
            price.className = 'price';
            price.textContent = `${Number(p.prix).toFixed(2)} ‚Ç¨`;

            const btnEdit = document.createElement('button');
            btnEdit.type = "button";
            btnEdit.className = 'btn-icon';
            btnEdit.title = t("edit.title");
            btnEdit.textContent = '‚úé';
            btnEdit.addEventListener('click', ()=>{
                openEdit(p);
            });

            const btnDel = document.createElement('button');
            btnDel.type = "button";
            btnDel.className = 'btn-icon btn-danger';
            btnDel.title = t("scenarios.deleteTitle");
            btnDel.textContent = 'üóë';
            btnDel.addEventListener('click', async ()=>{
                await deletePrestation(p.id);
            });

            right.appendChild(price);
            right.appendChild(btnEdit);
            right.appendChild(btnDel);

            card.appendChild(left);
            card.appendChild(right);

            card.addEventListener('dragstart', (e)=>{
                e.dataTransfer.setData('text/plain', String(p.id));
            });

            list.appendChild(card);
        });
    }

    /* ================= SCENARIO EDIT MODAL ================= */

    function openScenarioEdit(id){
        const nameEl = document.querySelector(`[data-scenario-name="${id}"]`);
        if(!nameEl) return;

        document.getElementById("editScenarioId").value = id;
        document.getElementById("editScenarioName").value = nameEl.textContent.trim();

        openModal("editScenarioModal");
    }

    async function saveScenarioEdit(){
        const id = document.getElementById("editScenarioId").value;
        const name = document.getElementById("editScenarioName").value.trim();
        if(!id || !name) return;

        try {
            const response = await fetch(`/api/admin/scenarios/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ nom: name })
            });

            if(!response.ok) {
                const error = await response.json();
                showToast(error.message || t("notifications.error"), 'error');
                return;
            }

            // mise √† jour imm√©diate dans l'UI
            const nameEl = document.querySelector(`[data-scenario-name="${id}"]`);
            if(nameEl) nameEl.textContent = name;

            closeModal("editScenarioModal");
            showToast(t("notifications.scenarioUpdated"), 'success');
        } catch(err) {
            showToast(t("notifications.error"), 'error');
        }
    }


    async function createPrestation(){
        const titre = $('#pTitre').value.trim();
        if(!titre) return;

        try {
            const response = await fetch('/api/admin/prestations', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({
                    titre,
                    description: $('#pDesc').value ?? '',
                    prix: parsePrice($('#pPrix').value)
                })
            });

            if(!response.ok) {
                const error = await response.json();
                showToast(error.message || t("notifications.error"), 'error');
                return;
            }

            $('#pTitre').value = '';
            $('#pDesc').value = '';
            $('#pPrix').value = '';

            await loadPrestations();
            await refreshAllScenarios();
            showToast(t("notifications.prestationCreated"), 'success');
        } catch(err) {
            showToast(t("notifications.error"), 'error');
        }
    }

    async function deletePrestation(id){
        if(!window.confirm(t("confirm.deletePrestation"))) return;

        try {
            const response = await fetch(`/api/admin/prestations/${id}`, { method:'DELETE' });

            if(!response.ok) {
                const error = await response.json();
                showToast(error.message || t("notifications.error"), 'error');
                return;
            }

            await loadPrestations();
            await refreshAllScenarios();
            showToast(t("notifications.prestationDeleted"), 'success');
        } catch(err) {
            showToast(t("notifications.error"), 'error');
        }
    }

    function openEdit(p){
        $('#editId').value = p.id;
        $('#editTitre').value = p.titre ?? '';
        $('#editDesc').value = p.description ?? '';
        $('#editPrix').value = (p.prix ?? 0);
        // update title i18n
        $('#editModalTitle').textContent = t("edit.title");
        openModal('editModal');
    }

    async function saveEdit(){
        const id = $('#editId').value;

        try {
            const response = await fetch(`/api/admin/prestations/${id}`, {
                method:'PUT',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({
                    titre: $('#editTitre').value ?? '',
                    description: $('#editDesc').value ?? '',
                    prix: parsePrice($('#editPrix').value)
                })
            });

            if(!response.ok) {
                const error = await response.json();
                showToast(error.message || t("notifications.error"), 'error');
                return;
            }

            closeModal('editModal');

            // reload from server = ensures persistence is visible
            await loadPrestations();
            await refreshAllScenarios();
            showToast(t("notifications.prestationUpdated"), 'success');
        } catch(err) {
            showToast(t("notifications.error"), 'error');
        }
    }

    /* ================= SCENARIOS (DnD + refresh) ================= */
    function wireDnD(scenarioEl){
        scenarioEl.addEventListener('dragover', e=>{
            e.preventDefault();
            scenarioEl.classList.add('dragover');
        });
        scenarioEl.addEventListener('dragleave', ()=>{
            scenarioEl.classList.remove('dragover');
        });
        scenarioEl.addEventListener('drop', async (e)=>{
            e.preventDefault();
            scenarioEl.classList.remove('dragover');

            const scenarioId = scenarioEl.dataset.scenarioId;
            const prestationId = e.dataTransfer.getData('text/plain');
            if(!scenarioId || !prestationId) return;

            try {
                const response = await fetch(`/api/scenarios/${scenarioId}/items?prestationId=${prestationId}`, { method:'POST' });

                if(!response.ok) {
                    const error = await response.json();
                    showToast(error.message || t("notifications.error"), 'error');
                    return;
                }

                await refreshScenario(scenarioId);
            } catch(err) {
                showToast(t("notifications.error"), 'error');
            }
        });
    }

    async function refreshScenario(id){
        const r = await fetch(`/api/scenarios/${id}`);
        const d = await r.json();

        const items = $(`[data-items-for="${id}"]`);
        const total = $(`[data-total-for="${id}"]`);
        if(!items) return;

        items.innerHTML = '';

        (d.items || []).forEach(i=>{
            const row = document.createElement('div');
            row.className = 'item';

            const left = document.createElement('div');
            left.className = 'item-title';
            left.textContent = i.titre ?? '';

            const right = document.createElement('div');
            right.className = 'item-right';

            const price = document.createElement('span');
            price.textContent = `${Number(i.prix).toFixed(2)} ‚Ç¨`;

            const btn = document.createElement('button');
            btn.type = "button";
            btn.className = 'btn-icon btn-danger';
            btn.title = t("scenarios.removeItemTitle");
            btn.textContent = '‚úï';
            btn.addEventListener('click', async ()=>{
                try {
                    const response = await fetch(`/api/scenarios/${id}/items?prestationId=${i.prestationId}`, { method:'DELETE' });

                    if(!response.ok) {
                        const error = await response.json();
                        showToast(error.message || t("notifications.error"), 'error');
                        return;
                    }

                    await refreshScenario(id);
                } catch(err) {
                    showToast(t("notifications.error"), 'error');
                }
            });

            right.appendChild(price);
            right.appendChild(btn);

            row.appendChild(left);
            row.appendChild(right);

            items.appendChild(row);
        });

        if(total) total.textContent = `${Number(d.total || 0).toFixed(2)} ‚Ç¨`;
    }

    async function refreshAllScenarios(){
        const scenarios = $$('.scenario');
        for(const s of scenarios){
            const id = s.dataset.scenarioId;
            if(id) await refreshScenario(id);
        }
    }

    async function createScenario(){
        const nom = $('#scenarioName').value.trim();
        if(!nom) return;

        try {
            const response = await fetch('/api/scenarios', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ nom })
            });

            if(!response.ok) {
                const error = await response.json();
                showToast(error.message || t("notifications.error"), 'error');
                return;
            }

            showToast(t("notifications.scenarioCreated"), 'success');
            location.reload();
        } catch(err) {
            showToast(t("notifications.error"), 'error');
        }
    }

    // endpoints admin (comme dans ton fichier stable)
    async function renameScenario(id){
        const el = $(`[data-scenario-name="${id}"]`);
        const current = el ? el.textContent : '';
        const n = prompt(t("scenarios.renameTitle"), current);
        if(n == null || !n.trim()) return;

        await fetch(`/api/admin/scenarios/${id}`, {
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ nom: n })
        });

        if(el) el.textContent = n;
    }

    async function deleteScenario(id){
        if(!window.confirm(t("confirm.deleteScenario"))) return;

        try {
            const response = await fetch(`/api/admin/scenarios/${id}`, { method:'DELETE' });

            if(!response.ok) {
                const error = await response.json();
                showToast(error.message || t("notifications.error"), 'error');
                return;
            }

            $(`.scenario[data-scenario-id="${id}"]`)?.remove();
            showToast(t("notifications.scenarioDeleted"), 'success');
        } catch(err) {
            showToast(t("notifications.error"), 'error');
        }
    }

    /* ================= BOOT ================= */
    (function boot(){
        window.__lang = localStorage.getItem("lang") || "fr";
        applyI18n();

        $$('.scenario').forEach(wireDnD);
        loadPrestations();
        refreshAllScenarios();
    })();
</script>

</body>
</html>
