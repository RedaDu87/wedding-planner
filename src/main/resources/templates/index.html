<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Wedding Planner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <style>
        :root{
            --bg:#f5f7fb;
            --card:#ffffff;
            --primary:#4f46e5;
            --primary-soft:#eef2ff;
            --accent:#d4af37;
            --text:#0f172a;
            --muted:#64748b;
            --border:#e5e7eb;
            --danger:#dc2626;
            --radius:18px;
        }
        *{box-sizing:border-box}
        body{
            margin:0;
            padding:16px;
            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
            background:var(--bg);
            color:var(--text);
        }
        h1{
            margin:0 0 20px;
            font-size:1.7rem;
            font-weight:700;
            display:flex;
            gap:10px;
        }
        h3{margin:0 0 14px;font-size:1.1rem;font-weight:600}
        .grid{
            display:grid;
            grid-template-columns:1fr;
            gap:18px;
        }
        .panel{
            background:var(--card);
            border-radius:var(--radius);
            padding:18px;
            box-shadow:0 20px 40px rgba(0,0,0,.08);
        }

        /* FORMS */
        .form{display:grid;gap:10px;margin-bottom:16px}
        input,textarea{
            width:100%;
            padding:12px 14px;
            border-radius:14px;
            border:1px solid var(--border);
            font-size:15px;
        }
        textarea{min-height:70px}
        button{
            border:none;
            border-radius:14px;
            padding:12px 16px;
            font-weight:600;
            cursor:pointer;
        }
        .btn-primary{background:var(--primary);color:#fff}
        .btn-primary:hover{background:#4338ca}
        .btn-icon{background:transparent;font-size:16px;padding:6px}
        .btn-danger{color:var(--danger)}

        /* PRESTATIONS */
        .cards{display:grid;gap:14px}
        .card{
            background:#fff;
            border:1px solid var(--border);
            border-radius:var(--radius);
            padding:16px;
            display:flex;
            justify-content:space-between;
            gap:14px;
            cursor:grab;
        }
        .card:hover{box-shadow:0 14px 30px rgba(0,0,0,.12)}
        .card-left{flex:1}
        .card-title{font-weight:700;margin-bottom:4px}
        .card-desc{font-size:13px;color:var(--muted)}
        .price{font-weight:700;color:var(--accent)}

        /* SCENARIOS */
        .scenarios{display:grid;gap:16px}
        .scenario{
            background:#fafafa;
            border:2px dashed var(--border);
            border-radius:var(--radius);
            padding:14px;
        }
        .scenario.dragover{background:var(--primary-soft);border-color:var(--primary)}
        .scenario-header{
            display:flex;
            justify-content:space-between;
            margin-bottom:10px;
        }
        .scenario-title{font-weight:700}
        .items{display:grid;gap:8px}
        .item{
            background:#fff;
            border:1px solid var(--border);
            border-radius:14px;
            padding:10px 12px;
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        @media(min-width:900px){
            body{padding:24px}
            .grid{grid-template-columns:420px 1fr}
            .scenarios{grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
        }
    </style>
</head>

<body>

<h1>üíç Wedding Planner</h1>

<div class="grid">

    <!-- PRESTATIONS -->
    <div class="panel">
        <h3>Prestations</h3>

        <div class="form">
            <input id="pTitre" placeholder="Nom de la prestation"/>
            <textarea id="pDesc" placeholder="Description d√©taill√©e"></textarea>
            <input id="pPrix" placeholder="Prix (‚Ç¨)"/>
            <button class="btn-primary" onclick="createPrestation()">Ajouter la prestation</button>
        </div>

        <div class="cards" id="prestations"></div>
    </div>

    <!-- SCENARIOS -->
    <div class="panel">
        <h3>Sc√©narios</h3>

        <div class="form">
            <input id="scenarioName" placeholder="Nom du sc√©nario"/>
            <button class="btn-primary" onclick="createScenario()">Cr√©er le sc√©nario</button>
        </div>

        <div class="scenarios" id="scenarios">
            <div class="scenario"
                 th:each="s : ${scenarios}"
                 th:attr="data-scenario-id=${s.id}">
                <div class="scenario-header">
                    <div class="scenario-title"
                         th:text="${s.nom}"
                         th:attr="data-scenario-name=${s.id}">
                    </div>
                    <div>
                        <span class="price" th:attr="data-total-for=${s.id}">0 ‚Ç¨</span>
                        <button class="btn-icon" th:attr="onclick=|renameScenario(${s.id})|">‚úé</button>
                        <button class="btn-icon btn-danger"
                                th:attr="onclick=|deleteScenario(${s.id})|">üóë</button>
                    </div>
                </div>
                <div class="items" th:attr="data-items-for=${s.id}"></div>
            </div>
        </div>
    </div>

</div>

<script>
    const escapeHtml=s=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const parsePrice=v=>Number(String(v).replace(',','.'))||0;

    /* PRESTATIONS */
    async function loadPrestations(){
        const r=await fetch('/api/admin/prestations');
        const d=await r.json();
        prestations.innerHTML='';
        d.forEach(p=>{
            const c=document.createElement('div');
            c.className='card';
            c.draggable=true;
            c.innerHTML=`
      <div class="card-left">
        <div class="card-title">${escapeHtml(p.titre)}</div>
        <div class="card-desc">${escapeHtml(p.description||'')}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="price">${p.prix.toFixed(2)} ‚Ç¨</div>
        <button class="btn-icon btn-danger"
                onclick="deletePrestation(${p.id})">üóë</button>
      </div>`;
            c.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',p.id));
            prestations.appendChild(c);
        });
    }

    async function createPrestation(){
        await fetch('/api/admin/prestations',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                titre:pTitre.value,
                description:pDesc.value,
                prix:parsePrice(pPrix.value)
            })
        });
        pTitre.value='';pDesc.value='';pPrix.value='';
        loadPrestations();
        refreshAllScenarios();
    }

    async function deletePrestation(id){
        await fetch(`/api/admin/prestations/${id}`,{method:'DELETE'});
        loadPrestations();
        refreshAllScenarios();
    }

    /* SCENARIOS */
    function wireDnD(el){
        el.addEventListener('dragover',e=>{e.preventDefault();el.classList.add('dragover')});
        el.addEventListener('dragleave',()=>el.classList.remove('dragover'));
        el.addEventListener('drop',async e=>{
            e.preventDefault();el.classList.remove('dragover');
            await fetch(`/api/scenarios/${el.dataset.scenarioId}/items?prestationId=${e.dataTransfer.getData('text/plain')}`,{method:'POST'});
            refreshScenario(el.dataset.scenarioId);
        });
    }

    async function refreshScenario(id){
        const r=await fetch(`/api/scenarios/${id}`);
        const d=await r.json();
        const items=document.querySelector(`[data-items-for="${id}"]`);
        const total=document.querySelector(`[data-total-for="${id}"]`);
        if(!items)return;
        items.innerHTML='';
        d.items.forEach(i=>{
            items.innerHTML+=`
      <div class="item">
        <div>${escapeHtml(i.titre)}</div>
        <div style="display:flex;gap:8px;align-items:center">
          <span>${i.prix.toFixed(2)} ‚Ç¨</span>
          <button class="btn-icon btn-danger"
                  onclick="removeItem(${id},${i.prestationId})">‚úï</button>
        </div>
      </div>`;
        });
        total.textContent=d.total.toFixed(2)+' ‚Ç¨';
    }

    async function removeItem(scenarioId,prestationId){
        await fetch(`/api/scenarios/${scenarioId}/items?prestationId=${prestationId}`,{method:'DELETE'});
        refreshScenario(scenarioId);
    }

    async function createScenario(){
        await fetch('/api/scenarios',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({nom:scenarioName.value})
        });
        location.reload();
    }

    async function renameScenario(id){
        const el=document.querySelector(`[data-scenario-name="${id}"]`);
        const newName=prompt("Nouveau nom du sc√©nario",el.textContent);
        if(!newName)return;
        await fetch(`/api/admin/scenarios/${id}`,{
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({nom:newName})
        });
        el.textContent=newName;
    }

    async function deleteScenario(id){
        await fetch(`/api/admin/scenarios/${id}`,{method:'DELETE'});
        document.querySelector(`.scenario[data-scenario-id="${id}"]`)?.remove();
    }

    const refreshAllScenarios=()=>document.querySelectorAll('.scenario')
        .forEach(s=>refreshScenario(s.dataset.scenarioId));

    document.querySelectorAll('.scenario').forEach(wireDnD);
    loadPrestations();
    refreshAllScenarios();
</script>

</body>
</html>
