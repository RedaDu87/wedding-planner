<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Wedding Planner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <style>
        /* ================= THEME ================= */
        :root{
            --bg-main: linear-gradient(135deg,#fdf2f8,#eef2ff,#f0fdf4);
            --panel-bg: #ffffff;
            --primary: #6366f1;
            --secondary: #ec4899;
            --accent: #d4af37;
            --danger: #ef4444;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e5e7eb;
            --overlay: rgba(15,23,42,.6);
            --radius: 20px;
        }

        *{box-sizing:border-box}

        body{
            margin:0;
            padding:20px;
            font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-main);
            color: var(--text-main);
        }

        h1{
            font-size:1.9rem;
            font-weight:900;
            margin-bottom:20px;
            background: linear-gradient(90deg,var(--primary),var(--secondary));
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
        }
        h3{
            margin:0 0 14px;
            font-size:1.2rem;
            font-weight:800;
        }

        /* ================= LAYOUT ================= */
        .grid{
            display:grid;
            grid-template-columns:1fr;
            gap:22px;
        }
        .panel{
            background:var(--panel-bg);
            border-radius:var(--radius);
            padding:20px;
            box-shadow:0 10px 30px rgba(0,0,0,.1);
        }

        /* ================= STACK ================= */
        .stack{
            display:grid;
            gap:12px;
            margin-bottom:18px;
        }

        /* ================= INPUTS ================= */
        input,textarea{
            width:100%;
            padding:14px 16px;
            border-radius:16px;
            border:1px solid var(--border);
            font-size:15px;
            background:#fafafa;
        }
        textarea{min-height:90px;resize:vertical}

        /* ================= BUTTONS ================= */
        button{
            border:none;
            border-radius:16px;
            padding:14px 18px;
            font-weight:700;
            cursor:pointer;
            transition:.2s;
        }
        .btn-primary{
            background:linear-gradient(135deg,var(--primary),var(--secondary));
            color:white;
        }
        .btn-primary:hover{opacity:.9}
        .btn-icon{
            background:transparent;
            padding:6px 10px;
            font-size:16px;
            border-radius:12px;
        }
        .btn-icon:hover{background:#f1f5f9}
        .btn-danger{color:var(--danger)}
        .price{
            font-weight:900;
            color:var(--accent);
            white-space:nowrap;
        }
        .muted{color:var(--text-muted);font-size:13px}

        /* ================= PRESTATIONS ================= */
        .cards{display:grid;gap:16px}
        .card{
            background:linear-gradient(135deg,#ffffff,#f8fafc);
            border:1px solid var(--border);
            border-radius:var(--radius);
            padding:18px;
            display:flex;
            justify-content:space-between;
            gap:14px;
            cursor:grab;
            user-select:none;
            transition:.2s;
        }
        .card:hover{
            transform:translateY(-2px);
            box-shadow:0 16px 40px rgba(0,0,0,.15);
        }
        .card-left{flex:1;min-width:0}
        .card-title{font-weight:900;margin-bottom:6px}
        .card-desc{
            font-size:13px;
            color:var(--text-muted);
            display:-webkit-box;
            -webkit-line-clamp:2;
            -webkit-box-orient:vertical;
            overflow:hidden;
            cursor:pointer;
        }
        .card-desc:hover{text-decoration:underline}

        /* ================= SCENARIOS ================= */
        .scenarios{display:grid;gap:18px}
        .scenario{
            background:linear-gradient(135deg,#f8fafc,#eef2ff);
            border:2px dashed #c7d2fe;
            border-radius:var(--radius);
            padding:16px;
            min-height:160px;
            transition:.2s;
        }
        .scenario.dragover{
            background:linear-gradient(135deg,#eef2ff,#ecfeff);
            border-color:var(--primary);
        }
        .scenario-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:10px;
            margin-bottom:12px;
        }
        .scenario-name{
            font-weight:900;
            font-size:1rem;
        }
        .scenario-actions{
            display:flex;
            gap:8px;
            align-items:center;
        }

        /* ================= ITEMS ================= */
        .items{display:grid;gap:10px}
        .item{
            background:#ffffff;
            border-radius:16px;
            border:1px solid var(--border);
            padding:12px 14px;
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:10px;
            max-width:100%;
        }
        /* TITRES COMPLETS DANS LES SC√âNARIOS */
        .item-title{
            font-weight:700;
            min-width:0;

            /* autorise le retour √† la ligne */
            white-space:normal;
            word-break:break-word;
            overflow-wrap:anywhere;

            line-height:1.35;
        }

        .item-right{
            display:flex;
            gap:8px;
            align-items:center;
            flex-shrink:0;
        }

        /* ================= MODALS ================= */
        .modal{
            position:fixed;
            inset:0;
            background:var(--overlay);
            display:none;
            align-items:center;
            justify-content:center;
            z-index:1000;
            padding:20px;
        }
        .modal.show{display:flex}
        .modal-content{
            background:linear-gradient(135deg,#ffffff,#f8fafc);
            border-radius:24px;
            padding:24px;
            width:100%;
            max-width:560px;
            box-shadow:0 50px 120px rgba(0,0,0,.35);
        }
        .modal-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:14px;
        }
        .modal-title{
            font-size:1.3rem;
            font-weight:900;
            background:linear-gradient(90deg,var(--primary),var(--secondary));
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
        }
        .modal-footer{
            display:flex;
            justify-content:flex-end;
            gap:10px;
            margin-top:16px;
        }

        /* ================= RESPONSIVE ================= */
        @media(min-width:900px){
            body{padding:30px}
            .grid{grid-template-columns:420px 1fr}
            .scenarios{grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
        }
    </style>
</head>

<body>

<h1>üíç Wedding Planner</h1>

<div class="grid">

    <!-- PRESTATIONS -->
    <div class="panel">
        <h3>Prestations</h3>

        <div class="stack">
            <input id="pTitre" placeholder="Nom de la prestation"/>
            <textarea id="pDesc" placeholder="Description d√©taill√©e"></textarea>
            <input id="pPrix" placeholder="Prix (‚Ç¨)"/>
            <button class="btn-primary" onclick="createPrestation()">Ajouter la prestation</button>
            <div class="muted">Glisse une prestation dans un sc√©nario ‚ú®</div>
        </div>

        <div class="cards" id="prestations"></div>
    </div>

    <!-- SCENARIOS -->
    <div class="panel">
        <h3>Sc√©narios</h3>

        <div class="stack">
            <input id="scenarioName" placeholder="Nom du sc√©nario"/>
            <button class="btn-primary" onclick="createScenario()">Cr√©er le sc√©nario</button>
        </div>

        <div class="scenarios" id="scenarios">
            <div class="scenario"
                 th:each="s : ${scenarios}"
                 th:attr="data-scenario-id=${s.id}">
                <div class="scenario-header">
                    <div class="scenario-name"
                         th:text="${s.nom}"
                         th:attr="data-scenario-name=${s.id}"></div>
                    <div class="scenario-actions">
                        <span class="price" th:attr="data-total-for=${s.id}">0 ‚Ç¨</span>
                        <button class="btn-icon" th:attr="onclick=|renameScenario(${s.id})|">‚úé</button>
                        <button class="btn-icon btn-danger"
                                th:attr="onclick=|deleteScenario(${s.id})|">üóë</button>
                    </div>
                </div>
                <div class="items" th:attr="data-items-for=${s.id}"></div>
            </div>
        </div>
    </div>

</div>

<!-- ================= MODALS ================= -->

<div class="modal" id="descModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="descTitle"></div>
            <button class="btn-icon" onclick="closeModal('descModal')">‚úï</button>
        </div>
        <div id="descBody" style="white-space:pre-line;color:#334155"></div>
    </div>
</div>

<div class="modal" id="editModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">√âditer la prestation</div>
            <button class="btn-icon" onclick="closeModal('editModal')">‚úï</button>
        </div>

        <input type="hidden" id="editId"/>
        <div class="stack">
            <input id="editTitre"/>
            <textarea id="editDesc"></textarea>
            <input id="editPrix"/>
            <div class="muted">Sauvegarde via l‚ÄôAPI backend</div>
        </div>

        <div class="modal-footer">
            <button onclick="closeModal('editModal')">Annuler</button>
            <button class="btn-primary" onclick="saveEdit()">Enregistrer</button>
        </div>
    </div>
</div>

<script>
    /* ================= UTILS ================= */
    const $ = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
    const parsePrice=v=>Number(String(v||'').replace(',','.'))||0;

    /* ================= MODALS ================= */
    function openModal(id){$( '#'+id ).classList.add('show')}
    function closeModal(id){$( '#'+id ).classList.remove('show')}
    $$('.modal').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)closeModal(m.id)}));
    document.addEventListener('keydown',e=>{if(e.key==='Escape')$$('.modal.show').forEach(m=>closeModal(m.id))});

    function showDesc(t,d){
        $('#descTitle').textContent=t||'Description';
        $('#descBody').textContent=d||'Aucune description';
        openModal('descModal');
    }

    /* ================= PRESTATIONS ================= */
    async function loadPrestations(){
        const r=await fetch('/api/admin/prestations');
        const d=await r.json();
        const list=$('#prestations');
        list.innerHTML='';
        d.forEach(p=>{
            const c=document.createElement('div');
            c.className='card';
            c.draggable=true;
            c.dataset.id=p.id;

            c.innerHTML=`
      <div class="card-left">
        <div class="card-title">${p.titre}</div>
        <div class="card-desc">Lire la description</div>
      </div>
      <div class="item-right">
        <div class="price">${Number(p.prix).toFixed(2)} ‚Ç¨</div>
        <button class="btn-icon" onclick='openEdit(${JSON.stringify(p)})'>‚úé</button>
        <button class="btn-icon btn-danger" onclick='deletePrestation(${p.id})'>üóë</button>
      </div>
    `;
            c.querySelector('.card-desc').onclick=()=>showDesc(p.titre,p.description);
            c.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',p.id));
            list.appendChild(c);
        });
    }

    async function createPrestation(){
        if(!$('#pTitre').value.trim())return;
        await fetch('/api/admin/prestations',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                titre:$('#pTitre').value,
                description:$('#pDesc').value,
                prix:parsePrice($('#pPrix').value)
            })
        });
        $('#pTitre').value=$('#pDesc').value=$('#pPrix').value='';
        loadPrestations(); refreshAllScenarios();
    }

    async function deletePrestation(id){
        await fetch(`/api/admin/prestations/${id}`,{method:'DELETE'});
        loadPrestations(); refreshAllScenarios();
    }

    function openEdit(p){
        $('#editId').value=p.id;
        $('#editTitre').value=p.titre;
        $('#editDesc').value=p.description||'';
        $('#editPrix').value=p.prix;
        openModal('editModal');
    }

    async function saveEdit(){
        const id=$('#editId').value;
        await fetch(`/api/admin/prestations/${id}`,{
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                titre:$('#editTitre').value,
                description:$('#editDesc').value,
                prix:parsePrice($('#editPrix').value)
            })
        });
        closeModal('editModal');
        loadPrestations(); refreshAllScenarios();
    }

    /* ================= SCENARIOS ================= */
    function wireDnD(s){
        s.addEventListener('dragover',e=>{e.preventDefault();s.classList.add('dragover')});
        s.addEventListener('dragleave',()=>s.classList.remove('dragover'));
        s.addEventListener('drop',async e=>{
            e.preventDefault();s.classList.remove('dragover');
            const pid=e.dataTransfer.getData('text/plain');
            if(!pid)return;
            await fetch(`/api/scenarios/${s.dataset.scenarioId}/items?prestationId=${pid}`,{method:'POST'});
            refreshScenario(s.dataset.scenarioId);
        });
    }

    async function refreshScenario(id){
        const r=await fetch(`/api/scenarios/${id}`);
        const d=await r.json();
        const items=$(`[data-items-for="${id}"]`);
        const total=$(`[data-total-for="${id}"]`);
        items.innerHTML='';
        d.items.forEach(i=>{
            const el=document.createElement('div');
            el.className='item';
            el.innerHTML=`
      <div class="item-title">${i.titre}</div>
      <div class="item-right">
        <span>${Number(i.prix).toFixed(2)} ‚Ç¨</span>
        <button class="btn-icon btn-danger">‚úï</button>
      </div>
    `;
            el.querySelector('button').onclick=async()=>{
                await fetch(`/api/scenarios/${id}/items?prestationId=${i.prestationId}`,{method:'DELETE'});
                refreshScenario(id);
            };
            items.appendChild(el);
        });
        total.textContent=Number(d.total||0).toFixed(2)+' ‚Ç¨';
    }

    async function refreshAllScenarios(){
        for(const s of $$('.scenario')) refreshScenario(s.dataset.scenarioId);
    }

    async function createScenario(){
        if(!$('#scenarioName').value.trim())return;
        await fetch('/api/scenarios',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({nom:$('#scenarioName').value})
        });
        location.reload();
    }

    async function renameScenario(id){
        const el=$(`[data-scenario-name="${id}"]`);
        const n=prompt('Nouveau nom',el.textContent);
        if(!n)return;
        await fetch(`/api/admin/scenarios/${id}`,{
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({nom:n})
        });
        el.textContent=n;
    }

    async function deleteScenario(id){
        await fetch(`/api/admin/scenarios/${id}`,{method:'DELETE'});
        $(`.scenario[data-scenario-id="${id}"]`)?.remove();
    }

    /* ================= BOOT ================= */
    (function(){
        $$('.scenario').forEach(wireDnD);
        loadPrestations();
        refreshAllScenarios();
    })();
</script>

</body>
</html>
